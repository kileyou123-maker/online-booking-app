<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šé ç´„èˆ‡ç®¡ç†ç³»çµ± - æœ¬æ©Ÿå„²å­˜ç‰ˆ</title>
    <style>
        /* ------------------------------------------- */
        /* 1. é€šç”¨èˆ‡å®¹å™¨å„ªåŒ–è¨­å®š */
        /* ------------------------------------------- */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f7f9fc;
            line-height: 1.6;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        .dashboard-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 40px;
            background-color: white;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05), 0 0 0 1px rgba(0, 0, 0, 0.03);
            min-height: 70vh;
        }

        h1 {
            color: #1e3a8a;
            font-size: 2.4em;
            margin-bottom: 35px;
            font-weight: 700;
            text-align: center;
        }

        h2 {
            color: #1e3a8a;
            font-size: 1.6em;
            border-bottom: 1px solid #e0e7ff;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 25px;
        }

        /* ------------------------------------------- */
        /* 2. å°èˆªæ¬„èˆ‡æ­¥é©ŸæŒ‡ç¤ºå™¨ */
        /* ------------------------------------------- */
        .main-nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 18px 0;
            width: 100%;
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .main-nav button {
            background: none;
            border: none;
            cursor: pointer;
            color: #4b5563;
            padding: 0 10px 15px 10px;
            font-weight: 500;
            font-size: 1em;
            transition: color 0.3s ease-out;
        }

        .main-nav button:hover {
            color: #2563eb;
        }

        .main-nav button.active {
            color: #1e3a8a;
            border-bottom: 3px solid #1e3a8a;
            font-weight: 600;
        }

        .booking-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 50px;
        }

        .step-indicator {
            padding: 10px 15px;
            border-radius: 50px;
            color: #9ca3af;
            background-color: #e5e7eb;
            margin: 0 10px;
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s;
        }

        .step-indicator.active {
            background-color: #1e3a8a;
            color: white;
            transform: scale(1.05);
        }

        /* ------------------------------------------- */
        /* 3. æ­¥é©Ÿå…§å®¹å€èˆ‡è¡¨å–®å…ƒç´ ç¾åŒ– (Client View) */
        /* ------------------------------------------- */

        /* æ­¥é©Ÿå…§å®¹å®¹å™¨ - æ¢å¾©å–®ç¨é¡¯ç¤ºæ¨¡å¼ï¼Œå¢åŠ å¤–è§€é‚Šæ¡† */
        .step-content {
            padding: 30px;
            padding-bottom: 80px; /* ç•™çµ¦åº•éƒ¨æŒ‰éˆ•ç©ºé–“ */
            border: 1px solid #d1d5db;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            background-color: white;
            position: relative; /* ç¢ºä¿æŒ‰éˆ•å®šä½æ­£å¸¸ */
        }
        
        /* æ›¿æ›æ»‘å‹•å‹•ç•«çš„ CSS - æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
        .fade-out {
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            display: block !important; /* æš«æ™‚ä¿æŒ block è®“å‹•ç•«æ’­æ”¾ */
            pointer-events: none; /* ç¦ç”¨é»æ“Š */
            position: absolute; /* è®“æ–°çš„æ­¥é©Ÿå¯ä»¥è¦†è“‹ä¸Šä¾† */
            width: 100%;
            top: 0;
            left: 0;
        }

        .fade-in {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s ease-in 0.1s, transform 0.3s ease-in 0.1s; /* å»¶é²æ·¡å…¥ï¼Œå‰µé€ å¹³é †æ„Ÿ */
            position: relative;
            z-index: 10;
        }
        /* ------------------------------------------- */

        label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        
        .step-content input[type="text"],
        .step-content input[type="email"],
        .step-content input[type="password"] {
            width: 100%;
            max-width: 400px; 
            padding: 14px 15px;
            margin-bottom: 20px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            color: #333;
            transition: all 0.3s;
        }
        
        .step-content select {
            max-width: 400px; 
            width: 100%; 
            padding: 14px 15px;
            margin-bottom: 20px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            color: #333;
            transition: all 0.3s;
        }


        .step-content input:focus,
        .step-content select:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
            outline: none;
        }

        .button-group {
            /* ä¿®æ­£æŒ‰éˆ•çµ„ä»¶å®šä½ï¼Œä½¿ç”¨çµ•å°å®šä½åœ¨åº•éƒ¨ï¼Œé€™æ˜¯æœ€ç©©å®šçš„æ–¹å¼ */
            position: absolute; 
            bottom: 30px; /* è·é›¢åº•éƒ¨ä¿æŒä¸€è‡´ */
            left: 30px;
            right: 30px;
            
            display: flex;
            justify-content: flex-start; /* é è¨­é å·¦å°é½Š */
            align-items: center;
            gap: 15px; 
        }
        
        /* è™•ç† Step 2 & 3 éœ€è¦ 'ä¸Šä¸€æ­¥' æŒ‰éˆ•æ™‚ */
        .button-group.space-between {
            justify-content: space-between;
        }
        
        /* è®“ Admin Login çš„æŒ‰éˆ•çµ„ä»¶ç½®ä¸­ */
        #admin-login-form .button-group {
             position: relative;
             bottom: auto;
             left: auto;
             right: auto;
             margin-top: 30px;
             padding-bottom: 0;
             justify-content: center;
        }
        
        /* ç¢ºä¿æ­¥é©Ÿ 1 çš„æŒ‰éˆ•çµ„ä»¶èˆ‡è¡¨å–®å°é½Š (é å·¦) */
        #step1 .button-group {
            justify-content: flex-start;
        }

        /* ------------------------------------------- */
        /* æŒ‰éˆ•æ¨£å¼å®šç¾© (å„ªåŒ–å¾Œ) */
        /* ------------------------------------------- */

        .step-content button, #admin-login-btn, #admin-logout-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 4px 10px rgba(0, 0, 0, 0.1);
        }

        .step-content button:not([disabled]):hover,
        #admin-login-btn:not([disabled]):hover, #admin-logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 6px 15px rgba(0, 0, 0, 0.15);
        }

        .step-content button:not([disabled]):active,
        #admin-login-btn:not([disabled]):active, #admin-logout-btn:active {
            transform: scale(0.98);
            box-shadow: 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* ä¸»è¦è¡Œå‹• */
        .step-content button[onclick*="nextStep(2)"],
        .step-content button[onclick*="nextStep(3)"],
        #admin-login-btn {
            background: linear-gradient(145deg, #10b981, #059669);
            color: white;
            box-shadow: 4px 15px rgba(16, 185, 129, 0.5);
            border: 1px solid #059669;
        }

        /* æœ€çµ‚ç¢ºèªé ç´„æŒ‰éˆ• - ç´…è‰² (ç¨ä½œèª¿æ•´) */
        .step-content button[onclick*="submitBooking"] {
            background-color: #ef4444; 
            color: white;
            box-shadow: 4px 15px rgba(239, 68, 68, 0.5);
            border: 1px solid #c83232;
        }

        /* æ¬¡è¦è¡Œå‹• (ä¸Šä¸€æ­¥) - æ·ºç°è‰²å¸¶è—é‚Š */
        .step-content button[onclick*="nextStep(1)"],
        .step-content button[onclick*="nextStep(2)"] {
            background-color: #ffffff; 
            color: #1e3a8a;
            border: 1px solid #bfdbfe;
            box-shadow: none;
        }
        
        /* ç®¡ç†å“¡ç™»å‡ºæŒ‰éˆ• - å¼·çƒˆç´…è‰² */
        #admin-logout-btn {
            background-color: #dc2626;
            color: white;
            box-shadow: 4px 15px rgba(220, 38, 38, 0.5);
            border: 1px solid #b91c1c;
        }
        
        /* ç¦ç”¨æŒ‰éˆ• */
        .step-content button:disabled,
        #admin-login-btn:disabled {
            background: #d1d5db !important;
            cursor: not-allowed;
            color: #9ca3af !important;
            box-shadow: none !important;
            transform: none !important;
            border: none !important;
        }

        /* ------------------------------------------- */
        /* 5. è‡ªå®šç¾©è¨Šæ¯æ¡† (å–ä»£ Alert) */
        /* ------------------------------------------- */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #fff;
            color: #1e3a8a;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            font-weight: 600;
        }
        
        .message-box.show {
            display: block;
            opacity: 1;
        }
        /* ------------------------------------------- */
        /* 6. å…¶ä»–å…ƒç´ æ¨£å¼ (ä¿æŒä¸è®Š) */
        /* ------------------------------------------- */

        /* Summary UI */
        #step3 ul li {
            background-color: #f4f7fc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #3b82f6;
            font-size: 1.05em;
        }

        #step3 ul li strong {
            color: #1e3a8a;
        }
        
        /* ç®¡ç†å“¡ä»‹é¢æ¨£å¼ */
        .loading-text {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
            font-style: italic;
        }
        
        .booking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        .booking-table th, .booking-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e7ff;
        }

        .booking-table th {
            background-color: #e0e7ff;
            color: #1e3a8a;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .booking-table tr:hover {
            background-color: #f8fafc;
        }
    </style>
</head>
<body>

<!-- è¨Šæ¯æ¡† -->
<div class="message-box" id="custom-message-box"></div>

<div class="main-nav">
    <button id="nav-client" onclick="switchView('client')" class="active">å®¢æˆ¶é ç´„</button>
    <button id="nav-admin" onclick="switchView('admin')">ç®¡ç†å“¡ç™»å…¥</button>
</div>

<div class="dashboard-container">
    
    <!-- 1. å®¢æˆ¶é ç´„ä»‹é¢ -->
    <div id="client-view">
        <h1>ğŸ—“ï¸ ç·šä¸Šé ç´„æœå‹™</h1>
        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
        <div class="booking-steps">
            <span class="step-indicator active" id="step1-indicator">1. é¸æ“‡æœå‹™</span>
            <span class="step-indicator" id="step2-indicator">2. é¸æ“‡æ™‚æ®µ</span>
            <span class="step-indicator" id="step3-indicator">3. ç¢ºèªé ç´„</span>
        </div>

        <!-- ç§»é™¤ steps-container/wrapperï¼Œæ­¥é©Ÿå…§å®¹ç¨ç«‹é¡¯ç¤º/éš±è— -->
        <!-- ç”±æ–¼ height è®ŠåŒ–ï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹å®¹å™¨ä¾†æ§åˆ¶é«˜åº¦éæ¸¡ï¼Œä½†ä¸éœ€è¦ wrapper -->
        <div class="steps-container" id="steps-container" style="position: relative;">
            
            <div class="step-content fade-in" id="step1" style="display: block;">
                <h2>é¸æ“‡æœå‹™é …ç›®</h2>
                <p>è«‹é¸æ“‡æ‚¨éœ€è¦çš„æœå‹™é¡å‹ï¼Œä»¥ä¾¿ç‚ºæ‚¨é¡¯ç¤ºæº–ç¢ºçš„æ™‚é•·å’Œåƒ¹æ ¼ã€‚</p>
                <select id="service-select">
                    <option value="">-- è«‹é¸æ“‡æœå‹™ --</option>
                    <option value="60" data-name="ä¸€å°æ™‚å°ˆæ¥­é¡§å•" data-price="2000">ä¸€å°æ™‚å°ˆæ¥­é¡§å• (NT$ 2000)</option>
                    <option value="90" data-name="90 åˆ†é˜æ·±åº¦è«®è©¢" data-price="2800">90 åˆ†é˜æ·±åº¦è«®è©¢ (NT$ 2800)</option>
                    <option value="120" data-name="åŠå¤©å·¥ä½œåŠ" data-price="4000">åŠå¤©å·¥ä½œåŠ (NT$ 4000)</option>
                    </select>
                
                <div class="button-group"> 
                    <button onclick="nextStep(2)">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <div class="step-content" id="step2" style="display: none;">
                <h2>é¸æ“‡æ—¥æœŸèˆ‡æ™‚é–“</h2>
                <p>æ‚¨é¸æ“‡çš„æœå‹™æ™‚é•·ç‚ºï¼š<span id="duration-display" style="font-weight: bold; color: #ef4444;"></span> åˆ†é˜ã€‚</p>
                
                <label for="date-select">é¸æ“‡å¯é ç´„æ—¥æœŸï¼š</label>
                <select id="date-select" onchange="renderTimeSlots()">
                </select>
                
                <label for="time-slot-select" style="margin-top: 10px;">é¸æ“‡å¯é ç´„æ™‚é–“ï¼š</label>
                <select id="time-slot-select" onchange="selectTimeSlot(this)">
                    <option value="" disabled selected>-- è«‹å…ˆé¸æ“‡æ—¥æœŸ --</option>
                </select>

                <div class="button-group space-between">
                    <button onclick="nextStep(1)">ä¸Šä¸€æ­¥</button>
                    <button onclick="nextStep(3)" id="confirm-time-button" disabled>ç¢ºèªæ™‚æ®µ</button>
                </div>
            </div>

            <div class="step-content" id="step3" style="display: none;">
                <h2>ç¢ºèªè³‡è¨Šèˆ‡é ç´„</h2>
                
                <p>è«‹ç¢ºèªæ‚¨çš„é ç´„è©³æƒ…ï¼š</p>
                <ul style="list-style: none; padding: 0;">
                    <li><strong>æœå‹™é …ç›®ï¼šï¼š</strong> <span id="summary-service" style="font-weight: bold;"></span></li>
                    <li><strong>é ç´„æ™‚æ®µï¼š</strong> <span id="summary-datetime" style="font-weight: bold;"></span></li>
                </ul>

                <label for="client-name">å§“å:</label>
                <input type="text" id="client-name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required>

                <label for="client-email">Email:</label>
                <input type="email" id="client-email" placeholder="è«‹è¼¸å…¥æœ‰æ•ˆçš„Emailåœ°å€" required>
                
                <div class="button-group space-between">
                    <button onclick="nextStep(2)">ä¸Šä¸€æ­¥</button>
                    <button onclick="submitBooking()">âœ… ç¢ºèªé€å‡ºé ç´„</button>
                </div>
            </div>

        </div> <!-- /.steps-container çµæŸæ¨™ç±¤ï¼Œç¾åœ¨å®ƒæ˜¯å–®å€‹æ­¥é©Ÿçš„å®¹å™¨ -->
    </div>
    
    <!-- 2. ç®¡ç†å“¡ä»‹é¢ (ç™»å…¥èˆ‡å„€è¡¨æ¿) -->
    <div id="admin-view" style="display: none;">
        <h1>ğŸ”‘ ç®¡ç†å“¡ç™»å…¥</h1>
        
        <!-- ç™»å…¥è¡¨å–® -->
        <div id="admin-login-form" class="step-content">
            <!-- åˆå§‹è¼‰å…¥/æç¤ºè¨Šæ¯ -->
            <p id="admin-login-message" class="loading-text" style="color:#374151; padding: 15px 0;">
                è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ (Demo: admin123)ã€‚
            </p>
            
            <label for="admin-password">å¯†ç¢¼ (Demo: admin123):</label>
            <input type="password" id="admin-password" placeholder="è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" required>
            
            <div class="button-group">
                <button id="admin-login-btn" onclick="adminLogin()">ç™»å…¥ç®¡ç†å„€è¡¨æ¿</button>
            </div>
            <p id="login-error" style="color: #ef4444; margin-top: 20px; display: none;">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</p>
        </div>

        <!-- å„€è¡¨æ¿ (ç™»å…¥æˆåŠŸå¾Œé¡¯ç¤º) -->
        <div id="admin-dashboard" class="step-content" style="display: none;">
            <div class="admin-header">
                <h2>æ‰€æœ‰é ç´„è¨˜éŒ„ (æœ¬æ©Ÿå„²å­˜)</h2>
                <button id="admin-logout-btn" onclick="adminLogout()">ç™»å‡º</button>
            </div>
            <div id="bookings-list">
                <p style="text-align: center; color: #666;">è¼‰å…¥é ç´„è³‡æ–™ä¸­...</p>
            </div>
        </div>
    </div>
</div>

<script>
    // ----------------------------------------------------
    // LOCAL STORAGE FALLBACK (å–ä»£ Firebase)
    // ----------------------------------------------------
    
    // æª¢æŸ¥æ ¸å¿ƒè®Šæ•¸æ˜¯å¦å·²åˆå§‹åŒ–ï¼Œé˜²æ­¢ç’°å¢ƒé‡è¤‡åŸ·è¡Œå°è‡´çš„è¡çª
    if (typeof window.nextStep === 'undefined') {
        
        // å°‡æ‰€æœ‰é‚è¼¯åŒ…è£¹åœ¨ä¸€å€‹ IIFE ä¸­ä»¥ç¢ºä¿ä½œç”¨åŸŸç¨ç«‹æ€§
        (function() {
            let isAdmin = false;
            let currentStep = 1;
            let selectedServiceDuration = 0;
            let selectedServiceName = '';
            let selectedDate = '';
            let selectedTime = '';

            // éœæ…‹å¯ç”¨æ™‚æ®µè³‡æ–™ (ä½¿ç”¨ const å®£å‘Šåœ¨ IIFE å…§éƒ¨)
            const availableSlots = {
                '2025-12-10': ['10:00', '11:30', '14:00', '15:30'],
                '2025-12-11': ['09:00', '11:00', '13:00', '14:30'],
                '2025-12-12': ['10:30', '12:00', '16:00'],
                '2025-12-13': ['10:00', '14:00', '15:30'],
                '2025-12-14': ['11:00', '15:00'],
            };
            
            // --- Message Box Function (Replaces alert()) ---
            function showMessage(message, type = 'info') {
                const msgBox = document.getElementById('custom-message-box');
                msgBox.textContent = message;
                msgBox.className = 'message-box show'; 
                
                if (type === 'error') {
                    msgBox.style.backgroundColor = '#fef2f2';
                    msgBox.style.color = '#ef4444';
                } else if (type === 'success') {
                    msgBox.style.backgroundColor = '#ecfdf5';
                    msgBox.style.color = '#10b981';
                } else {
                    msgBox.style.backgroundColor = '#eff6ff';
                    msgBox.style.color = '#1e3a8a';
                }

                setTimeout(() => {
                    msgBox.classList.remove('show');
                }, 3000);
            }
            
            /**
             * èª¿æ•´æ­¥é©Ÿå®¹å™¨çš„é«˜åº¦ï¼Œä»¥åŒ¹é…ç•¶å‰æ­¥é©Ÿçš„å…§å®¹é«˜åº¦ã€‚
             * @param {number} step - ç•¶å‰æ­¥é©Ÿç·¨è™Ÿ (1, 2, æˆ– 3)ã€‚
             */
            function adjustContainerHeight(step) {
                const stepElement = document.getElementById(`step${step}`);
                const container = document.getElementById('steps-container');
                
                if (stepElement && container) {
                    const newHeight = stepElement.clientHeight; 
                    container.style.height = `${newHeight}px`;
                }
            }


            // --- æ­¥é©Ÿåˆ‡æ›å‡½æ•¸ (æ”¹ç”¨æ·¡å…¥æ·¡å‡ºé‚è¼¯) ---
            window.nextStep = function(step) {
                const serviceSelect = document.getElementById('service-select');
                
                if (step < 1 || step > 3) return;

                // æ­¥é©Ÿæª¢æŸ¥èˆ‡æ•¸æ“šå‚³é
                if (step === 2) {
                    const duration = parseInt(serviceSelect.value);
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                    
                    if (!duration) {
                        showMessage("è«‹å…ˆé¸æ“‡æœå‹™é …ç›®ï¼", 'error');
                        return;
                    }
                    selectedServiceDuration = duration;
                    selectedServiceName = selectedOption.getAttribute('data-name');
                    document.getElementById('duration-display').textContent = duration;
                    initDateSelect(); 
                }
                
                if (step === 3) {
                    if (!selectedDate || !selectedTime) {
                        showMessage("è«‹é¸æ“‡æ—¥æœŸå’Œæ™‚é–“ï¼", 'error');
                        return;
                    }
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                    document.getElementById('summary-service').textContent = selectedOption.getAttribute('data-name') + ' (' + selectedOption.getAttribute('data-price') + ')';
                    document.getElementById('summary-datetime').textContent = `${selectedDate} ${selectedTime}`;
                }
                
                // 1. èª¿æ•´é«˜åº¦åˆ°ç›®æ¨™æ­¥é©Ÿçš„é«˜åº¦ (å…ˆèª¿æ•´é«˜åº¦ï¼Œå†æ’­æ”¾æ·¡å…¥æ·¡å‡º)
                adjustContainerHeight(step);
                
                const currentEl = document.getElementById(`step${currentStep}`);
                const nextEl = document.getElementById(`step${step}`);

                // 2. æ‡‰ç”¨ fade-out æ•ˆæœ
                if (currentEl && currentEl !== nextEl) {
                    currentEl.classList.add('fade-out');
                }

                // 3. å»¶é²å¾Œç§»é™¤èˆŠæ­¥é©Ÿï¼Œé¡¯ç¤ºæ–°æ­¥é©Ÿ (é…åˆ CSS transition 0.3s)
                setTimeout(() => {
                    if (currentEl && currentEl !== nextEl) {
                        currentEl.style.display = 'none';
                        currentEl.classList.remove('fade-out');
                    }
                    
                    // ç¢ºä¿æ–°å…ƒç´ æ˜¯ blockï¼Œä¸¦æ‡‰ç”¨ fade-in æ•ˆæœ
                    nextEl.style.display = 'block';
                    nextEl.classList.add('fade-in');

                    // ç§»é™¤ fade-in æ•ˆæœï¼Œç‚ºä¸‹æ¬¡å‹•ç•«æº–å‚™
                    setTimeout(() => {
                        nextEl.classList.remove('fade-in');
                    }, 400); // ç•¥é•·æ–¼ CSS ä¸Šçš„ 0.35s å»¶é²

                }, 300); // ç¢ºä¿ fade-out å·²ç¶“å®Œæˆ
                
                // æ›´æ–°æ­¥é©ŸæŒ‡ç¤ºå™¨
                document.getElementById(`step${currentStep}-indicator`).classList.remove('active');
                currentStep = step;
                document.getElementById(`step${currentStep}-indicator`).classList.add('active');
            }


            // --- View Switching ---
            window.switchView = function(view) {
                // åˆ‡æ›ä¸»è¦–åœ–çš„ display å±¬æ€§
                document.getElementById('client-view').style.display = view === 'client' ? 'block' : 'none';
                document.getElementById('admin-view').style.display = view === 'admin' ? 'block' : 'none';

                // æ›´æ–°å°èˆªåˆ—ç‹€æ…‹
                document.getElementById('nav-client').classList.remove('active');
                document.getElementById('nav-admin').classList.remove('active');
                document.getElementById(`nav-${view}`).classList.add('active');

                if (view === 'admin' && isAdmin) {
                    loadAdminDashboard();
                } else if (view === 'admin' && !isAdmin) {
                    // Show login form if admin view is requested but not logged in
                    document.getElementById('admin-dashboard').style.display = 'none';
                    document.getElementById('admin-login-form').style.display = 'block';
                }
                
                // Ensure client view step 1 is visible when switching back 
                if (view === 'client') {
                    // éš±è—æ‰€æœ‰æ­¥é©Ÿï¼Œç„¶å¾Œåªé¡¯ç¤ºæ­¥é©Ÿ 1
                    document.getElementById('step1').style.display = 'block';
                    document.getElementById('step2').style.display = 'none';
                    document.getElementById('step3').style.display = 'none';

                    // é‡ç½®æ­¥é©ŸæŒ‡ç¤ºå™¨å’Œç•¶å‰æ­¥é©Ÿ
                    document.querySelectorAll('.step-indicator').forEach(el => el.classList.remove('active'));
                    document.getElementById('step1-indicator').classList.add('active');
                    currentStep = 1;
                    
                    // ç«‹å³èª¿æ•´åˆ°æ­¥é©Ÿ 1 çš„é«˜åº¦
                    adjustContainerHeight(1); 
                }
            }

            // --- Admin Login/Logout ---
            window.adminLogin = function() {
                const password = document.getElementById('admin-password').value;
                const errorEl = document.getElementById('login-error');
                
                // HARDCODED DEMO PASSWORD
                if (password === 'admin123') { 
                    isAdmin = true;
                    errorEl.style.display = 'none';
                    loadAdminDashboard();
                    showMessage('ç™»å…¥æˆåŠŸï¼æ­¡è¿ï¼Œç®¡ç†å“¡ã€‚', 'success');
                } else {
                    errorEl.style.display = 'block';
                    showMessage('ç™»å…¥å¤±æ•—ï¼Œå¯†ç¢¼éŒ¯èª¤ã€‚', 'error');
                }
            }
            
            window.adminLogout = function() {
                isAdmin = false;
                document.getElementById('admin-dashboard').style.display = 'none';
                document.getElementById('admin-login-form').style.display = 'block';
                document.getElementById('admin-password').value = '';
                showMessage('å·²ç™»å‡ºç®¡ç†å“¡å¸³è™Ÿã€‚', 'info');
            }

            // --- Admin Dashboard Load (Local Storage) ---
            function loadAdminDashboard() {
                if (!isAdmin) return;
                
                document.getElementById('admin-login-form').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'block';
                
                const bookingsList = document.getElementById('bookings-list');
                
                try {
                    // å¾ localStorage è®€å–æ•¸æ“š
                    const bookingsJson = localStorage.getItem('clientBookings') || '[]';
                    let bookings = JSON.parse(bookingsJson);
                    
                    // å°‡è³‡æ–™è½‰æ›ç‚ºé™£åˆ—ä¸¦åœ¨è¨˜æ†¶é«”ä¸­æ’åº (ç”±æ–°åˆ°èˆŠ)
                    const sortedDocs = bookings
                        .sort((a, b) => {
                            // æ ¹æ“š timestamp æ¬„ä½ï¼Œç”±æ–°åˆ°èˆŠæ’åº
                            return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime();
                        });


                    if (sortedDocs.length === 0) {
                        bookingsList.innerHTML = '<p style="text-align: center; color: #666; padding: 30px;">ç›®å‰æ²’æœ‰ä»»ä½•é ç´„è¨˜éŒ„ã€‚</p>';
                        return;
                    }

                    let html = `
                        <table class="booking-table">
                            <thead>
                                <tr>
                                    <th>é ç´„æ™‚é–“</th>
                                    <th>å®¢æˆ¶å§“å/Email</th>
                                    <th>æœå‹™é …ç›®</th>
                                    <th>ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    sortedDocs.forEach(data => {
                        const date = new Date(data.timestamp).toLocaleString('zh-TW', { dateStyle: 'short', timeStyle: 'short' });
                        
                        html += `
                            <tr>
                                <td>${data.datetime} (${date})</td>
                                <td>${data.name}<br><small style="color:#6b7280;">${data.email}</small></td>
                                <td>${data.service}</td>
                                <td style="color: ${data.status === 'Confirmed' ? '#10b981' : '#f59e0b'};">${data.status}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                    
                    bookingsList.innerHTML = html;
                } catch (e) {
                    console.error("Error loading local storage bookings:", e);
                    bookingsList.innerHTML = `<p style="color: #ef4444; text-align: center;">è¼‰å…¥è³‡æ–™å¤±æ•—ï¼šæœ¬æ©Ÿå„²å­˜è³‡æ–™æ ¼å¼éŒ¯èª¤ã€‚</p>`;
                }
            }

            // ----------------------------------------------------
            // Client Side Logic
            // ----------------------------------------------------
            
            window.initDateSelect = function() {
                const dateSelect = document.getElementById('date-select');
                // Clear options except the first placeholder
                dateSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡æ—¥æœŸ --</option>';

                Object.keys(availableSlots).sort().forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    dateSelect.appendChild(option);
                });
                renderTimeSlots();
            }

            // æ¸²æŸ“æ™‚é–“åˆ° SELECT é¸å–®
            window.renderTimeSlots = function() {
                const dateSelect = document.getElementById('date-select');
                selectedDate = dateSelect.value;
                const timeSlotsContainer = document.getElementById('time-slot-select');
                
                // é‡ç½®é¸å–®
                timeSlotsContainer.innerHTML = '<option value="" disabled selected>-- è«‹é¸æ“‡æ™‚é–“ --</option>';
                
                selectedTime = '';
                document.getElementById('confirm-time-button').disabled = true;
                
                if (!selectedDate) {
                    // å¦‚æœæ²’æœ‰é¸æ“‡æ—¥æœŸï¼Œé¸å–®ä¿æŒé è¨­ç‹€æ…‹
                    return;
                }

                const slots = availableSlots[selectedDate] || [];
                
                if (slots.length === 0) {
                    timeSlotsContainer.innerHTML = '<option value="" disabled selected>è©²æ—¥æœŸæ²’æœ‰å¯ç”¨æ™‚æ®µ</option>';
                    return;
                }

                // æ·»åŠ æ™‚æ®µé¸é …
                slots.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    timeSlotsContainer.appendChild(option);
                });
                
                // ç¢ºä¿åœ¨æ¸²æŸ“æ™‚é–“é¸å–®å¾Œï¼Œç•¶å‰æ­¥é©Ÿ 2 çš„é«˜åº¦è¢«æ­£ç¢ºèª¿æ•´
                adjustContainerHeight(2); 
            }

            // è™•ç† SELECT é¸å–®çš„é¸æ“‡è®ŠåŒ–
            window.selectTimeSlot = function(element) {
                selectedTime = element.value;
                document.getElementById('confirm-time-button').disabled = !selectedTime;
            }

            window.submitBooking = function() {
                
                const name = document.getElementById('client-name').value.trim();
                const email = document.getElementById('client-email').value.trim();
                const serviceSelect = document.getElementById('service-select');
                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                const servicePrice = selectedOption.getAttribute('data-price');
                
                if (!name || !email) {
                    showMessage("è«‹å¡«å¯«æ‚¨çš„å§“åå’Œ Emailï¼", 'error');
                    return;
                }
                if (!/\S+@\S+\.\S+/.test(email)) {
                    showMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€ï¼", 'error');
                    return;
                }
                
                // ** Local Storage å„²å­˜é‚è¼¯ **
                const bookingDetails = {
                    name: name,
                    email: email,
                    service: selectedServiceName,
                    duration: selectedServiceDuration,
                    price: parseInt(servicePrice),
                    datetime: `${selectedDate} ${selectedTime}`,
                    status: 'Confirmed', 
                    timestamp: new Date().toISOString(),
                };
                
                try {
                    // è®€å–ç¾æœ‰é ç´„ï¼ŒåŠ å…¥æ–°é ç´„ï¼Œå†å„²å­˜
                    let bookings = JSON.parse(localStorage.getItem('clientBookings') || '[]');
                    bookings.push(bookingDetails);
                    localStorage.setItem('clientBookings', JSON.stringify(bookings));

                    showMessage(`ğŸ‰ é ç´„æˆåŠŸï¼æ‚¨çš„é ç´„å·²è¨˜éŒ„ã€‚`, 'success');
                    
                    // æ¸…ç©ºè¡¨å–®ä¸¦è¿”å›ç¬¬ä¸€æ­¥
                    setTimeout(() => {
                        window.location.reload(); 
                    }, 1000);
                    
                } catch (e) {
                    console.error("Error saving to local storage: ", e);
                    showMessage(`é ç´„å¤±æ•—ï¼šç„¡æ³•å„²å­˜åˆ°æœ¬æ©Ÿè¨˜æ†¶é«”ã€‚`, 'error');
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                // åˆå§‹è¼‰å…¥æ™‚ï¼Œèª¿æ•´åˆ°æ­¥é©Ÿ 1 çš„é«˜åº¦
                adjustContainerHeight(1);
                
                // Initial view load based on hash (optional, defaults to client)
                const initialView = window.location.hash.substring(1) || 'client';
                switchView(initialView);
            });
        })(); // ç«‹å³åŸ·è¡Œå‡½æ•¸çµæŸ
    }
</script>
</body>
</html>